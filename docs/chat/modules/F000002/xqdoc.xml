<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2022-09-07T10:37:45.23+01:00</xqdoc:date><xqdoc:version>1.1</xqdoc:version></xqdoc:control><xqdoc:module type="library"><xqdoc:uri>chat-ws</xqdoc:uri><xqdoc:name>chat-ws.xqm</xqdoc:name><xqdoc:comment><xqdoc:description>Simple WebSocket chat. WebSocket functions.</xqdoc:description><xqdoc:author>BaseX Team 2005-21, BSD License</xqdoc:author><xqdoc:custom tag="__source">chat-ws.xqm</xqdoc:custom></xqdoc:comment><xqdoc:body>(:~
 : Simple WebSocket chat. WebSocket functions.
 : @author BaseX Team 2005-21, BSD License
 :)
module namespace chat-ws = 'chat-ws';

import module namespace chat-util = 'chat/util' at 'chat-util.xqm';
import module namespace request = "http://exquery.org/ns/request";

(:~ 
 : Creates a WebSocket connection. Registers the user and notifies all clients.
 :)
declare
  %ws:connect('/chat')
function chat-ws:connect() as empty-sequence() {
  ws:set(ws:id(), $chat-util:id, session:get($chat-util:id)),
  chat-util:users()
};

(:~ 
 : Processes a WebSocket message.
 : @param  $message  message
 :)
declare
  %ws:message('/chat', '{$message}')
function chat-ws:message(
  $message  as xs:string
) as empty-sequence() {
  let $json := parse-json($message)
  let $type := $json?type
  return if($type = 'message') then (
    chat-util:message($json?text, $json?to)
  ) else if($type = 'ping') then(
    (: do nothing :)
  ) else error()
};

(:~ 
 : Closes a WebSocket connection. Unregisters the user and notifies all clients.
 :)
declare
  %ws:close('/chat')
function chat-ws:close() as empty-sequence() {
  ws:delete(ws:id(), $chat-util:id),
  chat-util:users()
};
</xqdoc:body></xqdoc:module><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>chat/util</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>http://exquery.org/ns/request</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:namespaces><xqdoc:namespace prefix="chat-ws" uri="chat-ws"/><xqdoc:namespace prefix="chat-util" uri="chat/util"/><xqdoc:namespace prefix="request" uri="http://exquery.org/ns/request"/><xqdoc:namespace prefix="ws" uri="http://basex.org/modules/ws"/></xqdoc:namespaces><xqdoc:variables/><xqdoc:functions><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Creates a WebSocket connection. Registers the user and notifies all clients.</xqdoc:description></xqdoc:comment><xqdoc:name>chat-ws:connect</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="ws:connect"><xqdoc:literal type="xs:string">/chat</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %ws:connect("/chat") function chat-ws:connect() as empty-sequence()</xqdoc:signature><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://basex.org/modules/ws</xqdoc:uri><xqdoc:name>set</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://basex.org/modules/ws</xqdoc:uri><xqdoc:name>id</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>get</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>users</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>id</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>id</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function chat-ws:connect() as empty-sequence() {
  ws:set(ws:id(), $chat-util:id, session:get($chat-util:id)),
  chat-util:users()
}</xqdoc:body></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description>Processes a WebSocket message.</xqdoc:description><xqdoc:param>$message  message</xqdoc:param></xqdoc:comment><xqdoc:name>chat-ws:message</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="ws:message"><xqdoc:literal type="xs:string">/chat</xqdoc:literal><xqdoc:literal type="xs:string">{$message}</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %ws:message("/chat", "{$message}") function chat-ws:message($message as xs:string) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>message</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>parse-json</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="2"><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>message</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>error</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>message</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>json</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>type</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>json</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>json</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>type</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function chat-ws:message(
  $message  as xs:string
) as empty-sequence() {
  let $json := parse-json($message)
  let $type := $json?type
  return if($type = 'message') then (
    chat-util:message($json?text, $json?to)
  ) else if($type = 'ping') then(
    (: do nothing :)
  ) else error()
}</xqdoc:body></xqdoc:function><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Closes a WebSocket connection. Unregisters the user and notifies all clients.</xqdoc:description></xqdoc:comment><xqdoc:name>chat-ws:close</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="ws:close"><xqdoc:literal type="xs:string">/chat</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %ws:close("/chat") function chat-ws:close() as empty-sequence()</xqdoc:signature><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="2"><xqdoc:uri>http://basex.org/modules/ws</xqdoc:uri><xqdoc:name>delete</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>http://basex.org/modules/ws</xqdoc:uri><xqdoc:name>id</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="0"><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>users</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>chat/util</xqdoc:uri><xqdoc:name>id</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function chat-ws:close() as empty-sequence() {
  ws:delete(ws:id(), $chat-util:id),
  chat-util:users()
}</xqdoc:body></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>