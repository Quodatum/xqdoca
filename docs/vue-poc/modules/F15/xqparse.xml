<XQuery>(:~ get datetaken
 : &lt;keyword name="2 orlop" count="31"&gt;
 :   &lt;dates earliest="2010-08-05T15:40:54" latest="2011-03-06T18:04:28"/&gt;
 :   &lt;idref&gt;14569796 14569818 &lt;/idref&gt;
 : &lt;/keyword&gt;
:)
<MainModule><Prolog><ModuleImport><TOKEN>import</TOKEN> <TOKEN>module</TOKEN> <TOKEN>namespace</TOKEN> <NCName>cfg</NCName> <TOKEN>=</TOKEN> <StringLiteral>"quodatum:media.image.configure"</StringLiteral> <TOKEN>at</TOKEN> <StringLiteral>"../config.xqm"</StringLiteral></ModuleImport><TOKEN>;</TOKEN>
<AnnotatedDecl><TOKEN>declare</TOKEN> <Annotation><TOKEN>%</TOKEN><QName>updating</QName></Annotation> <FunctionDecl><TOKEN>function</TOKEN> <QName>local:put</QName><TOKEN>(</TOKEN><ParamList><Param><TOKEN>$</TOKEN><QName>data</QName></Param><TOKEN>,</TOKEN><Param><TOKEN>$</TOKEN><QName>path</QName></Param></ParamList><TOKEN>)</TOKEN><EnclosedExpr><TOKEN>{</TOKEN>
   <FunctionCall><QName>db:replace</QName><ArgumentList><TOKEN>(</TOKEN><VarRef><TOKEN>$</TOKEN><QName>cfg:DB-IMAGE</QName></VarRef><TOKEN>,</TOKEN><VarRef><TOKEN>$</TOKEN><QName>path</QName></VarRef><TOKEN>,</TOKEN><VarRef><TOKEN>$</TOKEN><QName>data</QName></VarRef><TOKEN>)</TOKEN></ArgumentList></FunctionCall>
<TOKEN>}</TOKEN></EnclosedExpr></FunctionDecl></AnnotatedDecl><TOKEN>;</TOKEN>
<AnnotatedDecl><TOKEN>declare</TOKEN> <VarDecl><TOKEN>variable</TOKEN> <TOKEN>$</TOKEN><QName>DEST</QName><TOKEN>:=</TOKEN><StringLiteral>"/datetaken.xml"</StringLiteral></VarDecl></AnnotatedDecl><TOKEN>;</TOKEN></Prolog>

<FLWORExpr><LetClause><TOKEN>let</TOKEN> <LetBinding><TOKEN>$</TOKEN><QName>dates</QName><TOKEN>:=</TOKEN><DirElemConstructor><TOKEN>&lt;</TOKEN><QName>dates</QName><DirAttributeList><S>   </S><QName>date</QName><TOKEN>=</TOKEN><DirAttributeValue><TOKEN>"</TOKEN><EnclosedExpr><TOKEN>{</TOKEN><FunctionCall><QName>current-dateTime</QName><ArgumentList><TOKEN>(</TOKEN><TOKEN>)</TOKEN></ArgumentList></FunctionCall><TOKEN>}</TOKEN></EnclosedExpr><TOKEN>"</TOKEN></DirAttributeValue></DirAttributeList><TOKEN>&gt;</TOKEN><EnclosedExpr><TOKEN>{</TOKEN>
<FLWORExpr><ForClause><TOKEN>for</TOKEN> <ForBinding><TOKEN>$</TOKEN><QName>image</QName> <TOKEN>in</TOKEN> <RelativePathExpr><FunctionCall><QName>collection</QName><ArgumentList><TOKEN>(</TOKEN><StringConcatExpr><VarRef><TOKEN>$</TOKEN><QName>cfg:DB-IMAGE</QName></VarRef> <TOKEN>||</TOKEN> <StringLiteral>"/image"</StringLiteral></StringConcatExpr><TOKEN>)</TOKEN></ArgumentList></FunctionCall><TOKEN>/</TOKEN><AxisStep><QName>image</QName><Predicate><TOKEN>[</TOKEN><FunctionCall><QName>not</QName><ArgumentList><TOKEN>(</TOKEN><AxisStep><AbbrevForwardStep><TOKEN>@</TOKEN><QName>original</QName></AbbrevForwardStep><PredicateList/></AxisStep><TOKEN>)</TOKEN></ArgumentList></FunctionCall><TOKEN>]</TOKEN></Predicate></AxisStep></RelativePathExpr></ForBinding></ForClause>
<LetClause><TOKEN>let</TOKEN> <LetBinding><TOKEN>$</TOKEN><QName>year</QName><TOKEN>:=</TOKEN><FunctionCall><QName>substring</QName><ArgumentList><TOKEN>(</TOKEN><RelativePathExpr><VarRef><TOKEN>$</TOKEN><QName>image</QName></VarRef><TOKEN>/</TOKEN><AxisStep><QName>datetaken</QName><PredicateList/></AxisStep></RelativePathExpr><TOKEN>,</TOKEN><IntegerLiteral>1</IntegerLiteral><TOKEN>,</TOKEN><IntegerLiteral>4</IntegerLiteral><TOKEN>)</TOKEN></ArgumentList></FunctionCall></LetBinding></LetClause>

<GroupByClause><TOKEN>group</TOKEN> <TOKEN>by</TOKEN> <GroupingVariable><TOKEN>$</TOKEN><QName>year</QName></GroupingVariable></GroupByClause>
<OrderByClause><TOKEN>order</TOKEN> <TOKEN>by</TOKEN> <OrderSpec><VarRef><TOKEN>$</TOKEN><QName>year</QName></VarRef> <TOKEN>descending</TOKEN></OrderSpec></OrderByClause>

<ReturnClause><TOKEN>return</TOKEN> <DirElemConstructor><TOKEN>&lt;</TOKEN><QName>year</QName><DirAttributeList><S> </S><QName>value</QName><TOKEN>=</TOKEN><DirAttributeValue><TOKEN>"</TOKEN><EnclosedExpr><TOKEN>{</TOKEN><VarRef><TOKEN>$</TOKEN><QName>year</QName></VarRef><TOKEN>}</TOKEN></EnclosedExpr><TOKEN>"</TOKEN></DirAttributeValue><S> </S><TOKEN>count</TOKEN><TOKEN>=</TOKEN><DirAttributeValue><TOKEN>"</TOKEN><EnclosedExpr><TOKEN>{</TOKEN><FunctionCall><TOKEN>count</TOKEN><ArgumentList><TOKEN>(</TOKEN><VarRef><TOKEN>$</TOKEN><QName>image</QName></VarRef><TOKEN>)</TOKEN></ArgumentList></FunctionCall><TOKEN>}</TOKEN></EnclosedExpr><TOKEN>"</TOKEN></DirAttributeValue></DirAttributeList><TOKEN>&gt;</TOKEN><ElementContentChar>
</ElementContentChar><EnclosedExpr><TOKEN>{</TOKEN><FLWORExpr><ForClause><TOKEN>for</TOKEN> <ForBinding><TOKEN>$</TOKEN><QName>image</QName> <TOKEN>in</TOKEN> <VarRef><TOKEN>$</TOKEN><QName>image</QName></VarRef></ForBinding></ForClause>
<LetClause><TOKEN>let</TOKEN> <LetBinding><TOKEN>$</TOKEN><QName>month</QName><TOKEN>:=</TOKEN><FunctionCall><QName>substring</QName><ArgumentList><TOKEN>(</TOKEN><RelativePathExpr><VarRef><TOKEN>$</TOKEN><QName>image</QName></VarRef><TOKEN>/</TOKEN><AxisStep><QName>datetaken</QName><PredicateList/></AxisStep></RelativePathExpr><TOKEN>,</TOKEN><IntegerLiteral>6</IntegerLiteral><TOKEN>,</TOKEN><IntegerLiteral>2</IntegerLiteral><TOKEN>)</TOKEN></ArgumentList></FunctionCall></LetBinding></LetClause>
<GroupByClause><TOKEN>group</TOKEN> <TOKEN>by</TOKEN> <GroupingVariable><TOKEN>$</TOKEN><QName>month</QName></GroupingVariable></GroupByClause>
<OrderByClause><TOKEN>order</TOKEN> <TOKEN>by</TOKEN> <OrderSpec><VarRef><TOKEN>$</TOKEN><QName>month</QName></VarRef>
<OrderModifier/></OrderSpec></OrderByClause><ReturnClause><TOKEN>return</TOKEN> <DirElemConstructor><TOKEN>&lt;</TOKEN><QName>month</QName><DirAttributeList><S> </S><QName>value</QName><TOKEN>=</TOKEN><DirAttributeValue><TOKEN>"</TOKEN><EnclosedExpr><TOKEN>{</TOKEN><VarRef><TOKEN>$</TOKEN><QName>month</QName></VarRef><TOKEN>}</TOKEN></EnclosedExpr><TOKEN>"</TOKEN></DirAttributeValue><S> </S><TOKEN>count</TOKEN><TOKEN>=</TOKEN><DirAttributeValue><TOKEN>"</TOKEN><EnclosedExpr><TOKEN>{</TOKEN><FunctionCall><TOKEN>count</TOKEN><ArgumentList><TOKEN>(</TOKEN><VarRef><TOKEN>$</TOKEN><QName>image</QName></VarRef><TOKEN>)</TOKEN></ArgumentList></FunctionCall><TOKEN>}</TOKEN></EnclosedExpr><TOKEN>"</TOKEN></DirAttributeValue></DirAttributeList><TOKEN>/&gt;</TOKEN></DirElemConstructor></ReturnClause></FLWORExpr>
<TOKEN>}</TOKEN></EnclosedExpr><ElementContentChar>
</ElementContentChar><TOKEN>&lt;/</TOKEN><QName>year</QName><TOKEN>&gt;</TOKEN></DirElemConstructor></ReturnClause></FLWORExpr>
<TOKEN>}</TOKEN></EnclosedExpr><TOKEN>&lt;/</TOKEN><QName>dates</QName><TOKEN>&gt;</TOKEN></DirElemConstructor></LetBinding></LetClause>
<ReturnClause><TOKEN>return</TOKEN> <ArrowExpr><VarRef><TOKEN>$</TOKEN><QName>dates</QName></VarRef> <TOKEN>=&gt;</TOKEN><QName>local:put</QName><ArgumentList><TOKEN>(</TOKEN><VarRef><TOKEN>$</TOKEN><QName>DEST</QName></VarRef><TOKEN>)</TOKEN></ArgumentList></ArrowExpr></ReturnClause></FLWORExpr></MainModule> <EOF/></XQuery>