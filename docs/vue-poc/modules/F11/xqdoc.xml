<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2019-06-06T22:42:08.709+01:00</xqdoc:date><xqdoc:version>1.1</xqdoc:version></xqdoc:control><xqdoc:module type="main"><xqdoc:uri>pics-03-store-image.xq</xqdoc:uri><xqdoc:comment><xqdoc:description>generate image docs from meta docs 52 sec 
<metadata/> -&gt; <image/></xqdoc:description></xqdoc:comment><xqdoc:body>(:~ 
 : generate image docs from meta docs 52 sec 
 : &lt;metadata/&gt; -&gt; &lt;image/&gt; 
 :)
import module namespace metadata = 'expkg-zone58:image.metadata';
import module namespace cfg = "quodatum:media.image.configure" at "../config.xqm";
for $meta in collection($cfg:DB-IMAGE || "/meta")/metadata
  let $loc:=db:path($meta)=&gt;tokenize("/")
  let $name:=$loc[count($loc)-1]
  let $path:= subsequence($loc,2,count($loc)-2)=&gt;string-join("/")
  let $image:=&lt;image&gt; 
             &lt;file name="{$name}" path="{$path}"/&gt;{
                metadata:core($meta),
                metadata:geo($meta),
                metadata:keywords($meta)
              } &lt;/image&gt;
let $target:="image/"|| $path || "/image.xml"
return  db:replace($cfg:DB-IMAGE,$target=&gt;trace(),$image)</xqdoc:body></xqdoc:module><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>expkg-zone58:image.metadata</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:namespaces><xqdoc:namespace prefix="metadata" uri="expkg-zone58:image.metadata"/><xqdoc:namespace prefix="cfg" uri="quodatum:media.image.configure"/><xqdoc:namespace prefix="local" uri="http://www.w3.org/2005/xquery-local-functions"/></xqdoc:namespaces><xqdoc:variables/><xqdoc:functions><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>pseudo main function</xqdoc:description></xqdoc:comment><xqdoc:name>local:xqDoc-main</xqdoc:name><xqdoc:signature>local:xqDoc-main()</xqdoc:signature><xqdoc:body>for $meta in collection($cfg:DB-IMAGE || "/meta")/metadata
  let $loc:=db:path($meta)=&gt;tokenize("/")
  let $name:=$loc[count($loc)-1]
  let $path:= subsequence($loc,2,count($loc)-2)=&gt;string-join("/")
  let $image:=&lt;image&gt; 
             &lt;file name="{$name}" path="{$path}"/&gt;{
                metadata:core($meta),
                metadata:geo($meta),
                metadata:keywords($meta)
              } &lt;/image&gt;
let $target:="image/"|| $path || "/image.xml"
return  db:replace($cfg:DB-IMAGE,$target=&gt;trace(),$image)</xqdoc:body><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>collection</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/db</xqdoc:uri><xqdoc:name>path</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>count</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>subsequence</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>count</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>expkg-zone58:image.metadata</xqdoc:uri><xqdoc:name>core</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>expkg-zone58:image.metadata</xqdoc:uri><xqdoc:name>geo</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>expkg-zone58:image.metadata</xqdoc:uri><xqdoc:name>keywords</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://basex.org/modules/db</xqdoc:uri><xqdoc:name>replace</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="4"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>tokenize</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="4"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>string-join</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>trace</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri><xqdoc:name>DB-IMAGE</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>meta</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>loc</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>loc</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>loc</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>loc</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>name</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>path</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>meta</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>meta</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>meta</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>path</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri><xqdoc:name>DB-IMAGE</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>target</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>image</xqdoc:name></xqdoc:ref-variable><xqdoc:body>for $meta in collection($cfg:DB-IMAGE || "/meta")/metadata
  let $loc:=db:path($meta)=&gt;tokenize("/")
  let $name:=$loc[count($loc)-1]
  let $path:= subsequence($loc,2,count($loc)-2)=&gt;string-join("/")
  let $image:=&lt;image&gt; 
             &lt;file name="{$name}" path="{$path}"/&gt;{
                metadata:core($meta),
                metadata:geo($meta),
                metadata:keywords($meta)
              } &lt;/image&gt;
let $target:="image/"|| $path || "/image.xml"
return  db:replace($cfg:DB-IMAGE,$target=&gt;trace(),$image)</xqdoc:body></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>