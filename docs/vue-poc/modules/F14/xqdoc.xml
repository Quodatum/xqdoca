<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2019-05-29T12:58:24.547+01:00</xqdoc:date><xqdoc:version>1.1</xqdoc:version></xqdoc:control><xqdoc:module type="main"><xqdoc:uri>pics-06-keywords.xq</xqdoc:uri><xqdoc:comment><xqdoc:description>get keywords
<keyword name="2 orlop" count="31">
  <dates earliest="2010-08-05T15:40:54" latest="2011-03-06T18:04:28"/>
  <idref>14569796 14569818 </idref>
</keyword></xqdoc:description></xqdoc:comment><xqdoc:body>(:~ get keywords
 : &lt;keyword name="2 orlop" count="31"&gt;
 :   &lt;dates earliest="2010-08-05T15:40:54" latest="2011-03-06T18:04:28"/&gt;
 :   &lt;idref&gt;14569796 14569818 &lt;/idref&gt;
 : &lt;/keyword&gt;
:)
import module namespace cfg = "quodatum:media.image.configure" at "../config.xqm";
declare %updating function local:put($data,$path){
   db:replace($cfg:DB-IMAGE,$path,$data)
};
declare variable $DEST:="/keywords.xml";

let $images:=collection($cfg:DB-IMAGE || "/image")/image
let $keywords:= $images/keywords/keyword=&gt;distinct-values()
let $kd:=&lt;keywords date="{current-dateTime()}"&gt;{
          for $k in $keywords
          order by lower-case($k)
          let $i:=$images[keywords/keyword = $k]
          let $i:=sort($i,(),function($x){$x/datetaken})
          let $earliest:=head($i)
          let $latest:=$i[last()]
          return &lt;keyword name="{$k}" count="{count($i)}"&gt;
              &lt;dates earliest="{$earliest/datetaken}" latest="{$latest/datetaken}"/&gt;
          &lt;idref &gt;{db:node-id($i)=&gt;string-join(" ")}&lt;/idref&gt;
          &lt;/keyword&gt;
          }&lt;/keywords&gt;
return $kd=&gt;local:put($DEST)
</xqdoc:body></xqdoc:module><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:namespaces><xqdoc:namespace prefix="cfg" uri="quodatum:media.image.configure"/><xqdoc:namespace prefix="local" uri="http://www.w3.org/2005/xquery-local-functions"/><xqdoc:namespace prefix="ann" uri="http://www.w3.org/2012/xquery"/><xqdoc:namespace prefix="local" uri="http://www.w3.org/2005/xquery-local-functions"/></xqdoc:namespaces><xqdoc:variables><xqdoc:variable><xqdoc:name>DEST</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:variable></xqdoc:variables><xqdoc:functions><xqdoc:function arity="2"><xqdoc:name>local:put</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="updating"/></xqdoc:annotations><xqdoc:signature>declare %updating function local:put($data as item()*, $path as item()*) as item()*</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>data</xqdoc:name><xqdoc:type occurrence="*">item()</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>path</xqdoc:name><xqdoc:type occurrence="*">item()</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="3"><xqdoc:uri>http://basex.org/modules/db</xqdoc:uri><xqdoc:name>replace</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri><xqdoc:name>DB-IMAGE</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>path</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>data</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function local:put($data,$path){
   db:replace($cfg:DB-IMAGE,$path,$data)
}</xqdoc:body></xqdoc:function><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>pseudo main function</xqdoc:description></xqdoc:comment><xqdoc:name>local:xqDoc-main</xqdoc:name><xqdoc:signature>local:xqDoc-main()</xqdoc:signature><xqdoc:body>let $images:=collection($cfg:DB-IMAGE || "/image")/image
let $keywords:= $images/keywords/keyword=&gt;distinct-values()
let $kd:=&lt;keywords date="{current-dateTime()}"&gt;{
          for $k in $keywords
          order by lower-case($k)
          let $i:=$images[keywords/keyword = $k]
          let $i:=sort($i,(),function($x){$x/datetaken})
          let $earliest:=head($i)
          let $latest:=$i[last()]
          return &lt;keyword name="{$k}" count="{count($i)}"&gt;
              &lt;dates earliest="{$earliest/datetaken}" latest="{$latest/datetaken}"/&gt;
          &lt;idref &gt;{db:node-id($i)=&gt;string-join(" ")}&lt;/idref&gt;
          &lt;/keyword&gt;
          }&lt;/keywords&gt;
return $kd=&gt;local:put($DEST)</xqdoc:body><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>collection</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>current-dateTime</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>lower-case</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>sort</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>head</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>last</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>count</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/db</xqdoc:uri><xqdoc:name>node-id</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>distinct-values</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="4"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>string-join</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="3"><xqdoc:uri>http://www.w3.org/2005/xquery-local-functions</xqdoc:uri><xqdoc:name>put</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>quodatum:media.image.configure</xqdoc:uri><xqdoc:name>DB-IMAGE</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>images</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>keywords</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>k</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>images</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>k</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>i</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>x</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>i</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>i</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>k</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>i</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>earliest</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>latest</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>i</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>kd</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>DEST</xqdoc:name></xqdoc:ref-variable><xqdoc:body>let $images:=collection($cfg:DB-IMAGE || "/image")/image
let $keywords:= $images/keywords/keyword=&gt;distinct-values()
let $kd:=&lt;keywords date="{current-dateTime()}"&gt;{
          for $k in $keywords
          order by lower-case($k)
          let $i:=$images[keywords/keyword = $k]
          let $i:=sort($i,(),function($x){$x/datetaken})
          let $earliest:=head($i)
          let $latest:=$i[last()]
          return &lt;keyword name="{$k}" count="{count($i)}"&gt;
              &lt;dates earliest="{$earliest/datetaken}" latest="{$latest/datetaken}"/&gt;
          &lt;idref &gt;{db:node-id($i)=&gt;string-join(" ")}&lt;/idref&gt;
          &lt;/keyword&gt;
          }&lt;/keywords&gt;
return $kd=&gt;local:put($DEST)</xqdoc:body></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>