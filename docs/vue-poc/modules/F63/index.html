<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta http-equiv="Generator" content="xqdoca - https://github.com/quodatum/xqdoca"><title>vue-poc - xqDocA
        </title><link rel="shortcut icon" type="image/x-icon" href="../../resources/xqdoc.png"><link rel="stylesheet" type="text/css" href="../../resources/prism.css"><link rel="stylesheet" type="text/css" href="../../resources/page.css"><link rel="stylesheet" type="text/css" href="../../resources/query.css"><link rel="stylesheet" type="text/css" href="../../resources/base.css"></head><body class="home" id="top"><div id="main"><div><h1><span class="badge badge-info">http://quodatum.com/ns/pipeline</span>&nbsp;
			<small>library module</small><span title="RestXQ" class="badge badge-success" style="float:right">R</span></h1><dl><dt class="label">Summary</dt><dd>pipeline library</dd><dt>Tags</dt><dd><p>Author: Andy Bunce</p><p>Version: 0.2</p><p>date : nov 2017 jun 2018</p><p>__source : lib/pipeline.xqm</p></dd></dl><div> Imported by <a href="../../imports.html#http://quodatum.com/ns/pipeline">*</a></div><ul><li style="display:inline">Raw XML files: </li><li style="display:inline"><a href="xqdoc.xml" target="xqdoc">xqdoc.xml</a>, </li><li style="display:inline"><a href="xqparse.xml" target="xqparse">xqparse.xml</a></li></ul><nav id="toc"><h2><a href="../../index.html">vue-poc</a>
                / Module
       </h2><h3><a id="contents"></a><span class="">http://quodatum.com/ns/pipeline</span></h3><ol class="toc"><li><a href="#main"><span class="secno">1 </span><span class="content">Introduction</span></a></li><li><a href="#imports"><span class="secno">2 </span><span class="content">Imports</span></a></li><li><ol class="toc"><li><a href="#variables"><span class="secno">3 </span><span class="content">Variables</span></a><ol class="toc"><li><a href="#$qipe:outputs"><span class="secno">3.1</span><span class="content">$qipe:outputs</span></a></li></ol></li></ol></li><li><ol class="toc"><li><a href="#functions"><span class="secno">4 </span><span class="content">Functions</span></a><ol class="toc"><li><a href="#qipe:dir"><span class="secno">4.1</span><span class="content" title="">qipe:dir<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:identity"><span class="secno">4.2</span><span class="content" title="">qipe:identity<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:load"><span class="secno">4.3</span><span class="content" title="">qipe:load<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:log"><span class="secno">4.4</span><span class="content" title="">qipe:log<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:pipeline"><span class="secno">4.5</span><span class="content" title="">qipe:pipeline<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:relax-ng"><span class="secno">4.6</span><span class="content" title="">qipe:relax-ng<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:resolve"><span class="secno">4.7</span><span class="content" title="">qipe:resolve<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:run"><span class="secno">4.8</span><span class="content" title="">qipe:run<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:schematron"><span class="secno">4.9</span><span class="content" title="">qipe:schematron<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:step"><span class="secno">4.10</span><span class="content" title="">qipe:step<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:store"><span class="secno">4.11</span><span class="content" title="">qipe:store<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:validate"><span class="secno">4.12</span><span class="content" title="">qipe:validate<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:validate-dtd"><span class="secno">4.13</span><span class="content" title="">qipe:validate-dtd<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:validate-pipeline"><span class="secno">4.14</span><span class="content" title="">qipe:validate-pipeline<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:validate-xsd"><span class="secno">4.15</span><span class="content" title="">qipe:validate-xsd<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:xquery"><span class="secno">4.16</span><span class="content" title="">qipe:xquery<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li><li><a href="#qipe:xslt"><span class="secno">4.17</span><span class="content" title="">qipe:xslt<div class="badge badge-success" style="float:right" title="RESTXQ:">R</div><div class="badge badge-danger" style="float:right" title="Updating">U</div></span></a></li></ol></li></ol></li><li><a href="#namespaces"><span class="secno">5 </span><span class="content">Namespaces</span></a></li><li><ol class="toc"><li><a href="#restxq"><span class="secno">6 </span><span class="content">Restxq</span></a><ol class="toc"><xsl:for-each-group xmlns:xsl="http://www.w3.org/1999/XSL/Transform" select="qd:restxq($funs)" group-by="doc:literal/string()"><xsl:sort select="current-grouping-key()"></xsl:sort><xsl:variable name="id" select="current-grouping-key()"></xsl:variable><li><a href="# TODO"><span class="secno"><xsl:value-of select="concat('5.',position())"></xsl:value-of></span><span class="content"><xsl:value-of select="current-grouping-key()"></xsl:value-of></span></a></li></xsl:for-each-group></ol></li></ol></li><li><a href="#source"><span class="secno">7 </span><span class="content">Source</span></a></li></ol></nav><div class="div2"><h2><a id="imports"></a>2 Imports</h2><p><span class="badge badge-info">this</span> module is imported by
    <span class="badge badge-info">1</span> modules, it imports
    <span class="badge badge-info">2</span> modules.
    </p><div style="display: flex;width:100%; justify-content: space-between;"><div style="width:30%;"><div><span><a href="../../modules/F23/index.html" title="features\pipeline\pipe.xq">pipe.xq</a></span></div></div><div><div>imports</div>→</div><div class="badge badge-info">this</div><div><div>imports</div>→</div><div style="width:30%;"><div><span class="badge badge-warning" title="External file">http://github.com/Schematron/schematron-basex</span></div><div><span class="badge badge-warning" title="External file">quodatum:file.walker</span></div></div></div></div><div class="div2"><h2><a id="variables"></a>3 Variables
			</h2><div class="div3"><h3><a id="$qipe:outputs"></a>3.1&nbsp;$qipe:outputs</h3><dl><dt class="label">Summary</dt><dd></dd><dt class="label">Type</dt><dd>map(*)</dd></dl></div></div><div class="div2"><h2><a id="functions"></a>4 Functions</h2><div class="div3"><h3><a id="qipe:dir"></a>4.1&nbsp;qipe:dir<div style="float:right"><a href="#qipe:dir">#</a></div></h3><dt class="label">Summary</dt><dd>append directory-list  to accumulator</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:dir</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:directory-list)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:directory-list)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 4 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>not#1</td></tr><tr><td>Fn</td><td>quodatum:file.walker</td><td>directory-list#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:dir($acc,$this  as element(qipe:directory-list),$opts as map(*))
{
  let $inc:=$this/@include-filter/string()
  let $href:=$this/@href/string()
  let $result:=fw:directory-list($href,map{"include-filter": $inc})
  let $result:= document { $result } transform with { delete  node //c:directory[not(.//c:file)]}
  return ($acc,$result)
}</code></pre></details></div><div class="div3"><h3><a id="qipe:identity"></a>4.2&nbsp;qipe:identity<div style="float:right"><a href="#qipe:identity">#</a></div></h3><dt class="label">Summary</dt><dd>identity</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:identity</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:pipeline)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:pipeline)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#4</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:identity($acc,$this as element(qipe:pipeline),$opts as map(*))
{
   $acc=&gt;trace("IDENT")
}</code></pre></details></div><div class="div3"><h3><a id="qipe:load"></a>4.3&nbsp;qipe:load<div style="float:right"><a href="#qipe:load">#</a></div></h3><dt class="label">Summary</dt><dd>load from file system</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:load</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 6 functions from 4 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://expath.org/ns/file</td><td>is-dir#1</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>resolve#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2001/XMLSchema</td><td>QName#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>doc#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>error#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#4</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:load($acc,$this,$opts as map(*) )
{ 
 let $href:=qipe:resolve($this/@href)=&gt;trace("load")
 let $new:=if(file:is-dir($href)) then  
                error(xs:QName('qipe'), 'dir loading not implemented') (: @TODO load all:)
            else 
               doc($href)
 return ($acc,$new)
}</code></pre></details></div><div class="div3"><h3><a id="qipe:log"></a>4.4&nbsp;qipe:log<div style="float:right"><a href="#qipe:log">#</a></div></h3><dt class="label">Summary</dt><dd>log msg</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:log</code>
		  ( 
			<code class="arg">$text</code><code class="as">&nbsp;as&nbsp;</code><code class="type">xs:string</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">empty-sequence()</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>text<code class="as">&nbsp;as&nbsp;</code><code class="return-type">xs:string</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">empty-sequence()</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/admin</td><td>write-log#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:log($text as xs:string,$opts as map(*) )
as empty-sequence()
{ 
 if($opts?log) then
      admin:write-log(``[[`{ $opts?id }`] `{$text}`]``,"QIPE")
 else    
   ()        
}</code></pre></details></div><div class="div3"><h3><a id="qipe:pipeline"></a>4.5&nbsp;qipe:pipeline<div style="float:right"><a href="#qipe:pipeline">#</a></div></h3><dt class="label">Summary</dt><dd>subpipe</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:pipeline</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:pipeline)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:pipeline)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>run#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:pipeline($acc,$this as element(qipe:pipeline),$opts as map(*))
{
  let $a:=qipe:run($this,$acc)
  return $acc
}</code></pre></details></div><div class="div3"><h3><a id="qipe:relax-ng"></a>4.6&nbsp;qipe:relax-ng<div style="float:right"><a href="#qipe:relax-ng">#</a></div></h3><dt class="label">Summary</dt><dd>validate with relax-ng</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:relax-ng</code>
		  ( 
			<code class="arg">$doc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$rng</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(report)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>doc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>rng<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(report)</code></li></ul></dd><details><summary>References 2 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/validate</td><td>rng-report#3</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>matches#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:relax-ng($doc,$rng )
as element(report)
{
  let $compact:=matches($rng,".*\.rnc")
 return validate:rng-report($doc,$rng,$compact) 
}</code></pre></details></div><div class="div3"><h3><a id="qipe:resolve"></a>4.7&nbsp;qipe:resolve<div style="float:right"><a href="#qipe:resolve">#</a></div></h3><dt class="label">Summary</dt><dd>resolve locations relative to this document typically from @href</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:resolve</code>
		  ( 
			<code class="arg">$href</code><code class="as">&nbsp;as&nbsp;</code><code class="type">node()?</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="?">xs:anyURI</xqdoc:type>?</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>href<code class="as">&nbsp;as&nbsp;</code><code class="return-type">node()?</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">xs:anyURI?</code></li></ul></dd><details><summary>References 2 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>base-uri#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>resolve-uri#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:resolve($href as node()? )
{ 
 resolve-uri( $href,base-uri($href))
}</code></pre></details></div><div class="div3"><h3><a id="qipe:run"></a>4.8&nbsp;qipe:run<div style="float:right"><a href="#qipe:run">#</a></div></h3><dt class="label">Summary</dt><dd>run a pipeline</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:run</code>
		  ( 
			<code class="arg">$pipe</code><code class="as">&nbsp;as&nbsp;</code><code class="type">node()</code>, <code class="arg">$initial</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>pipe<code class="as">&nbsp;as&nbsp;</code><code class="return-type">node()</code> the pipeline document</li><li>initial<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code> starting data as sequence</li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><p>result : </p><details><summary>References 7 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>log#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>log#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>step#3</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>true#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>true#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>count#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>fold-left#3</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:run($pipe as node(),$initial as item()* )
as item()*
{
  let $opts:=map{"id":"66", "log":true(),"trace":true()}
  let $_:=qipe:log( "start: " || count($initial),$opts)
  let $steps:=$pipe/qipe:*
  let $result:= fold-left($steps,$initial,qipe:step(?,?,$opts))
  return (
          $result,
          qipe:log( "end: ",$opts)
        )
}</code></pre></details></div><div class="div3"><h3><a id="qipe:run"></a>4.9&nbsp;qipe:run<div style="float:right"><a href="#qipe:run">#</a></div></h3><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:run</code>
		  ( 
			<code class="arg">$pipe</code><code class="as">&nbsp;as&nbsp;</code><code class="type">node()</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>pipe<code class="as">&nbsp;as&nbsp;</code><code class="return-type">node()</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>run#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:run($pipe as node() )
as item()*
{
  qipe:run($pipe,())
}</code></pre></details></div><div class="div3"><h3><a id="qipe:schematron"></a>4.10&nbsp;qipe:schematron<div style="float:right"><a href="#qipe:schematron">#</a></div></h3><dt class="label">Summary</dt><dd>validate with schematron
NOTE: relative paths in doc() references in schematron may cause issues</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:schematron</code>
		  ( 
			<code class="arg">$doc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$uri-sch</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(report)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>doc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>uri-sch<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(report)</code></li></ul></dd><details><summary>References 4 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://github.com/Schematron/schematron-basex</td><td>compile#1</td></tr><tr><td>Fn</td><td>http://github.com/Schematron/schematron-basex</td><td>is-valid#1</td></tr><tr><td>Fn</td><td>http://github.com/Schematron/schematron-basex</td><td>validate#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>doc#1</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:schematron($doc,$uri-sch )
as element(report)
{
  let $sch := schematron:compile(doc($uri-sch))
  let $svrl := schematron:validate($doc, $sch)
  return &lt;report&gt;
            &lt;status&gt;{
              if(schematron:is-valid($svrl)) then 'valid' else 'invalid'
            }&lt;/status&gt;
           {$svrl}
   &lt;/report&gt;          
}</code></pre></details></div><div class="div3"><h3><a id="qipe:step"></a>4.11&nbsp;qipe:step<div style="float:right"><a href="#qipe:step">#</a></div></h3><dt class="label">Summary</dt><dd>run a step</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:step</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element()</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code> current state</li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element()</code> current step as qipe:* element</li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 12 functions from 3 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>validate#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>xquery#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>xslt#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>load#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>store#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>dir#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>pipeline#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>identity#3</td></tr><tr><td>Fn</td><td>http://www.w3.org/2001/XMLSchema</td><td>QName#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>name#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>error#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#4</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:step($acc,$this as element(*),$opts as map(*))
{
  typeswitch($this=&gt;trace("RUNNING:"))
  case element(qipe:validate)  return qipe:validate($acc,$this,$opts)
  case element(qipe:xquery) return qipe:xquery($acc,$this,$opts)
  case element(qipe:xslt) return qipe:xslt($acc,$this,$opts)
  case element(qipe:load) return qipe:load($acc,$this,$opts)
  case element(qipe:store) return qipe:store($acc,$this,$opts)
  case element(qipe:directory-list) return qipe:dir($acc,$this,$opts)
  case element(qipe:pipeline) return qipe:pipeline($acc,$this,$opts)
  case element(qipe:identity) return qipe:identity($acc,$this,$opts)
  default return error(xs:QName('qipe'), 'unknown step:' || name($this))
}</code></pre></details></div><div class="div3"><h3><a id="qipe:store"></a>4.12&nbsp;qipe:store<div style="float:right"><a href="#qipe:store">#</a></div></h3><dt class="label">Summary</dt><dd>store each item in accumulator at computed path</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:store</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:store)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:store)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 11 functions from 4 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/xquery</td><td>eval#2</td></tr><tr><td>Fn</td><td>http://expath.org/ns/file</td><td>parent#1</td></tr><tr><td>Fn</td><td>http://expath.org/ns/file</td><td>is-dir#1</td></tr><tr><td>Fn</td><td>http://expath.org/ns/file</td><td>create-dir#1</td></tr><tr><td>Fn</td><td>http://expath.org/ns/file</td><td>write#3</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>resolve#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>boolean#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>current-date#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>format-date#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:store($acc,$this  as element(qipe:store),$opts as map(*))
{
  let $href:=qipe:resolve($this/@base)
  let $dated:=boolean($this/@dated)
  let $name:=$this/@fileExpression/string()
  let $output:=($this/@output/string(),"xml")[1]
  let $eval:="declare variable $position external :=0; " || $name
  let $href:=$href || (if( $dated) then 
                          format-date(current-date(),"/[Y0001][M01][D01]") 
                       else 
                          ())
  
          for $item at $pos in $acc
          let $name:=xquery:eval($eval,
                                 map{"":$item,
                                     "position": $pos}) (:eval against doc:)
          let $dest:=$href || "/" || $name
          let $dir:=file:parent($dest)
          return (
                 $item
                 ,if(file:is-dir($dir)) then () else file:create-dir($dir)
                 ,file:write($dest,$item,$qipe:outputs?($output))
                 )
}</code></pre></details></div><div class="div3"><h3><a id="qipe:validate"></a>4.13&nbsp;qipe:validate<div style="float:right"><a href="#qipe:validate">#</a></div></h3><dt class="label">Summary</dt><dd>run validate step based on @type</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:validate</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:validate)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:validate)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 15 functions from 3 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>resolve#1</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>relax-ng#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>schematron#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>validate-xsd#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>validate-dtd#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>log#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2001/XMLSchema</td><td>QName#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2001/XMLSchema</td><td>QName#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>boolean#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>string#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>base-uri#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>error#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>error#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:validate($acc,$this as element(qipe:validate),$opts as map(*))
{
  let $href:=qipe:resolve($this/@href)
  let $failOnError:=boolean($this/@failOnError)
  let $fn:= switch ($this/@type/string())
             case "relax-ng" return  qipe:relax-ng(?,$href )
             case "schematron" return  qipe:schematron(?,$href )
             case "xml-schema" return  qipe:validate-xsd(?,$href )
             case "dtd" return  qipe:validate-dtd(?,$href )
             default return error(xs:QName('qipe'), 'unknown validation type: ' || $this/@type/string() )
  for  $doc at $i in $acc
  let $report:=$fn($doc)
  let $_:=qipe:log("validate: " || $i,$opts)
  
  return  
         if($report/status = "valid") then
             $doc
         else
           let $_:=trace($report,"validation errors")
           return  if($failOnError) then
                        error(xs:QName('qipe'), 
                        ' validation fails: ' || $i || "=" || base-uri($doc))
                   else
                       $doc
}</code></pre></details></div><div class="div3"><h3><a id="qipe:validate-dtd"></a>4.14&nbsp;qipe:validate-dtd<div style="float:right"><a href="#qipe:validate-dtd">#</a></div></h3><dt class="label">Summary</dt><dd>validate with dtd</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:validate-dtd</code>
		  ( 
			<code class="arg">$doc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$dtd</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(report)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>doc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>dtd<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(report)</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/validate</td><td>dtd-report#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:validate-dtd($doc,$dtd )
as element(report)
{ 
  validate:dtd-report($doc,$dtd) 
}</code></pre></details></div><div class="div3"><h3><a id="qipe:validate-pipeline"></a>4.15&nbsp;qipe:validate-pipeline<div style="float:right"><a href="#qipe:validate-pipeline">#</a></div></h3><dt class="label">Summary</dt><dd>check pipeline is valid against schema</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:validate-pipeline</code>
		  ( 
			<code class="arg">$pipe</code><code class="as">&nbsp;as&nbsp;</code><code class="type">document-node()</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">document-node()</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>pipe<code class="as">&nbsp;as&nbsp;</code><code class="return-type">document-node()</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">document-node()</code></li></ul></dd><details><summary>References 2 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/validate</td><td>rng#3</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>true#1</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:validate-pipeline($pipe as document-node() )
as document-node()
{
 validate:rng($pipe , "schemas/pipeline.rnc",true()),$pipe
}</code></pre></details></div><div class="div3"><h3><a id="qipe:validate-xsd"></a>4.16&nbsp;qipe:validate-xsd<div style="float:right"><a href="#qipe:validate-xsd">#</a></div></h3><dt class="label">Summary</dt><dd>validate with xml-schema</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:validate-xsd</code>
		  ( 
			<code class="arg">$doc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$xsd</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0">element(report)</xqdoc:type></code></div></dd><dt class="label">Parameters</dt><dd><ul><li>doc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>xsd<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">element(report)</code></li></ul></dd><details><summary>References 1 functions from 1 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/validate</td><td>xsd-report#2</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:validate-xsd($doc,$xsd )
as element(report)
{ 
  validate:xsd-report($doc,$xsd) 
}</code></pre></details></div><div class="div3"><h3><a id="qipe:xquery"></a>4.17&nbsp;qipe:xquery<div style="float:right"><a href="#qipe:xquery">#</a></div></h3><dt class="label">Summary</dt><dd>run xquery referenced by @href and append result sequence to accumulator</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:xquery</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:xquery)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:xquery)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 4 functions from 2 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/xquery</td><td>invoke#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>base-uri#1</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>resolve-uri#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#4</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:xquery($acc,$this  as element(qipe:xquery),$opts as map(*))
{
  let $href:=resolve-uri($this/@href,base-uri($this))=&gt;trace("AT")
  let $result:=xquery:invoke($href,map{'': $acc})
  return ($acc,$result)
}</code></pre></details></div><div class="div3"><h3><a id="qipe:xslt"></a>4.18&nbsp;qipe:xslt<div style="float:right"><a href="#qipe:xslt">#</a></div></h3><dt class="label">Summary</dt><dd>apply XSLT transform to each item in accumulator</dd><dt class="label">Signature</dt><dd><div class="proto"><code class="function">qipe:xslt</code>
		  ( 
			<code class="arg">$acc</code><code class="as">&nbsp;as&nbsp;</code><code class="type">item()*</code>, <code class="arg">$this</code><code class="as">&nbsp;as&nbsp;</code><code class="type">element(qipe:xslt)</code>, <code class="arg">$opts</code><code class="as">&nbsp;as&nbsp;</code><code class="type">map(*)</code>
	 )
			<code class="as">&nbsp;as&nbsp;</code><code class="return-type"><xqdoc:type xmlns:xqdoc="http://www.xqdoc.org/1.0" occurrence="*">item()</xqdoc:type>*</code></div></dd><dt class="label">Parameters</dt><dd><ul><li>acc<code class="as">&nbsp;as&nbsp;</code><code class="return-type">item()*</code></li><li>this<code class="as">&nbsp;as&nbsp;</code><code class="return-type">element(qipe:xslt)</code></li><li>opts<code class="as">&nbsp;as&nbsp;</code><code class="return-type">map(*)</code></li></ul></dd><dt class="label">Return</dt><dd><ul><li><code class="return-type">item()*</code></li></ul></dd><details><summary>References 5 functions from 3 modules </summary><table class="data"><thead><tr><td>Type</td><td>uri</td><td>Name</td></tr></thead><tbody><tr><td>Fn</td><td>http://basex.org/modules/xslt</td><td>transform#2</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>resolve#1</td></tr><tr><td>Fn</td><td>http://quodatum.com/ns/pipeline</td><td>log#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#2</td></tr><tr><td>Fn</td><td>http://www.w3.org/2005/xpath-functions</td><td>trace#4</td></tr></tbody></table></details><details><summary>External functions that invoke this function</summary>
      todo
      </details><details><summary>Source</summary><pre><code class="language-xquery">function qipe:xslt($acc,$this  as element(qipe:xslt),$opts as map(*))
{
  let $href:=qipe:resolve($this/@href)=&gt;trace("XSLT")
  for $d at $i in $acc
  let $_:=qipe:log("xslt: " || $i,$opts)
  let $_:=trace($d,"ddd")
  return xslt:transform($d, $href)  
}</code></pre></details></div></div><div class="div2"><h2><a id="namespaces"></a>5 Namespaces</h2><p>The following namespaces are defined:</p><table class="data" style="float:none"><thead><tr><th>Prefix</th><th>Uri</th></tr></thead><tbody><tr><td>c</td><td>http://www.w3.org/ns/xproc-step</td></tr><tr><td>fw</td><td>quodatum:file.walker</td></tr><tr><td>qipe</td><td>http://quodatum.com/ns/pipeline</td></tr><tr><td>schematron</td><td>http://github.com/Schematron/schematron-basex</td></tr></tbody></table></div><div class="div2"><h2><a id="restxq"></a>6 RestXQ</h2><p>None</p></div><div class="div2"><h2><a id="source"></a>7 Source Code</h2><pre><code class="language-xquery">(:~ 
 :  pipeline library 
 : @author Andy Bunce
 : @version 0.2
 : @date nov 2017 jun 2018
:)
module namespace  qipe='http://quodatum.com/ns/pipeline';
import module namespace schematron = "http://github.com/Schematron/schematron-basex";
import module namespace fw="quodatum:file.walker";

declare namespace c="http://www.w3.org/ns/xproc-step";
declare variable $qipe:outputs:=map{
                            "html5": map{"method": "html","version":"5.0"},
                            "xml":  map{"indent": "no"}
                            };
(:~  run a pipeline 
 : @param $pipe the pipeline document
 : @param $initial starting data as sequence
 : @result 
 :)
declare function qipe:run($pipe as node(),$initial as item()* )
as item()*
{
  let $opts:=map{"id":"66", "log":true(),"trace":true()}
  let $_:=qipe:log( "start: " || count($initial),$opts)
  let $steps:=$pipe/qipe:*
  let $result:= fold-left($steps,$initial,qipe:step(?,?,$opts))
  return (
          $result,
          qipe:log( "end: ",$opts)
        )
};

declare function qipe:run($pipe as node() )
as item()*
{
  qipe:run($pipe,())
};

(:~ check pipeline is valid against schema :)
declare function qipe:validate-pipeline($pipe as document-node() )
as document-node()
{
 validate:rng($pipe , "schemas/pipeline.rnc",true()),$pipe
};

(:~  run a step 
 : @param $acc current state
 : @param $this current step as qipe:* element
 :)
declare function qipe:step($acc,$this as element(*),$opts as map(*))
{
  typeswitch($this=&gt;trace("RUNNING:"))
  case element(qipe:validate)  return qipe:validate($acc,$this,$opts)
  case element(qipe:xquery) return qipe:xquery($acc,$this,$opts)
  case element(qipe:xslt) return qipe:xslt($acc,$this,$opts)
  case element(qipe:load) return qipe:load($acc,$this,$opts)
  case element(qipe:store) return qipe:store($acc,$this,$opts)
  case element(qipe:directory-list) return qipe:dir($acc,$this,$opts)
  case element(qipe:pipeline) return qipe:pipeline($acc,$this,$opts)
  case element(qipe:identity) return qipe:identity($acc,$this,$opts)
  default return error(xs:QName('qipe'), 'unknown step:' || name($this))
};

(:~  subpipe
:)
declare function qipe:pipeline($acc,$this as element(qipe:pipeline),$opts as map(*))
{
  let $a:=qipe:run($this,$acc)
  return $acc
};

(:~  identity
:)
declare function qipe:identity($acc,$this as element(qipe:pipeline),$opts as map(*))
{
   $acc=&gt;trace("IDENT")
};
 
(:~  run validate step based on @type
:)
declare function qipe:validate($acc,$this as element(qipe:validate),$opts as map(*))
{
  let $href:=qipe:resolve($this/@href)
  let $failOnError:=boolean($this/@failOnError)
  let $fn:= switch ($this/@type/string())
             case "relax-ng" return  qipe:relax-ng(?,$href )
             case "schematron" return  qipe:schematron(?,$href )
             case "xml-schema" return  qipe:validate-xsd(?,$href )
             case "dtd" return  qipe:validate-dtd(?,$href )
             default return error(xs:QName('qipe'), 'unknown validation type: ' || $this/@type/string() )
  for  $doc at $i in $acc
  let $report:=$fn($doc)
  let $_:=qipe:log("validate: " || $i,$opts)
  
  return  
         if($report/status = "valid") then
             $doc
         else
           let $_:=trace($report,"validation errors")
           return  if($failOnError) then
                        error(xs:QName('qipe'), 
                        ' validation fails: ' || $i || "=" || base-uri($doc))
                   else
                       $doc
};

(:~  
 : append directory-list  to accumulator
 :)
declare function qipe:dir($acc,$this  as element(qipe:directory-list),$opts as map(*))
{
  let $inc:=$this/@include-filter/string()
  let $href:=$this/@href/string()
  let $result:=fw:directory-list($href,map{"include-filter": $inc})
  let $result:= document { $result } transform with { delete  node //c:directory[not(.//c:file)]}
  return ($acc,$result)
};

(:~  
 : run xquery referenced by @href and append result sequence to accumulator
 :)
declare function qipe:xquery($acc,$this  as element(qipe:xquery),$opts as map(*))
{
  let $href:=resolve-uri($this/@href,base-uri($this))=&gt;trace("AT")
  let $result:=xquery:invoke($href,map{'': $acc})
  return ($acc,$result)
};

(:~  
 : apply XSLT transform to each item in accumulator
 :)
declare function qipe:xslt($acc,$this  as element(qipe:xslt),$opts as map(*))
{
  let $href:=qipe:resolve($this/@href)=&gt;trace("XSLT")
  for $d at $i in $acc
  let $_:=qipe:log("xslt: " || $i,$opts)
  let $_:=trace($d,"ddd")
  return xslt:transform($d, $href)  
};

(:~  
 : store each item in accumulator at computed path
 :)
declare function qipe:store($acc,$this  as element(qipe:store),$opts as map(*))
{
  let $href:=qipe:resolve($this/@base)
  let $dated:=boolean($this/@dated)
  let $name:=$this/@fileExpression/string()
  let $output:=($this/@output/string(),"xml")[1]
  let $eval:="declare variable $position external :=0; " || $name
  let $href:=$href || (if( $dated) then 
                          format-date(current-date(),"/[Y0001][M01][D01]") 
                       else 
                          ())
  
          for $item at $pos in $acc
          let $name:=xquery:eval($eval,
                                 map{"":$item,
                                     "position": $pos}) (:eval against doc:)
          let $dest:=$href || "/" || $name
          let $dir:=file:parent($dest)
          return (
                 $item
                 ,if(file:is-dir($dir)) then () else file:create-dir($dir)
                 ,file:write($dest,$item,$qipe:outputs?($output))
                 )
};

(:~  validate with xml-schema  :)
declare function qipe:validate-xsd($doc,$xsd )
as element(report)
{ 
  validate:xsd-report($doc,$xsd) 
};

(:~  validate with dtd  :)
declare function qipe:validate-dtd($doc,$dtd )
as element(report)
{ 
  validate:dtd-report($doc,$dtd) 
};

(:~  validate with relax-ng  :)
declare function qipe:relax-ng($doc,$rng )
as element(report)
{
  let $compact:=matches($rng,".*\.rnc")
 return validate:rng-report($doc,$rng,$compact) 
};


(:~ 
 : validate with schematron
 : NOTE: relative paths in doc() references in schematron may cause issues  
  :)
declare function qipe:schematron($doc,$uri-sch )
as element(report)
{
  let $sch := schematron:compile(doc($uri-sch))
  let $svrl := schematron:validate($doc, $sch)
  return &lt;report&gt;
            &lt;status&gt;{
              if(schematron:is-valid($svrl)) then 'valid' else 'invalid'
            }&lt;/status&gt;
           {$svrl}
   &lt;/report&gt;          
};

(:~  load from file system  :)
declare function qipe:load($acc,$this,$opts as map(*) )
{ 
 let $href:=qipe:resolve($this/@href)=&gt;trace("load")
 let $new:=if(file:is-dir($href)) then  
                error(xs:QName('qipe'), 'dir loading not implemented') (: @TODO load all:)
            else 
               doc($href)
 return ($acc,$new)
};

(:~  resolve locations relative to this document typically from @href :)
declare function qipe:resolve($href as node()? )
{ 
 resolve-uri( $href,base-uri($href))
};

(:~  log msg :)
declare function qipe:log($text as xs:string,$opts as map(*) )
as empty-sequence()
{ 
 if($opts?log) then
      admin:write-log(``[[`{ $opts?id }`] `{$text}`]``,"QIPE")
 else    
   ()        
};</code></pre></div></div></div><div class="footer"><p style="text-align:right">Generated by 
            <a href="https://github.com/Quodatum/xqdoca" target="_blank">xqDocA</a> 
            at 2019-05-22T11:22:52.354+01:00</p></div><script src="../../resources/prism.js" type="text/javascript"></script></body></html>