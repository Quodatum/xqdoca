<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2019-06-05T22:42:25.62+01:00</xqdoc:date><xqdoc:version>1.1</xqdoc:version></xqdoc:control><xqdoc:module type="library"><xqdoc:uri>dba/session</xqdoc:uri><xqdoc:name>session.xqm</xqdoc:name><xqdoc:comment><xqdoc:description>Session values.</xqdoc:description><xqdoc:author>Christian Grün, BaseX Team 2005-19, BSD License</xqdoc:author><xqdoc:custom tag="__source">modules/session.xqm</xqdoc:custom></xqdoc:comment><xqdoc:body>(:~
 : Session values.
 :
 : @author Christian Grün, BaseX Team 2005-19, BSD License
 :)
module namespace session = 'dba/session';

import module namespace options = 'dba/options' at 'options.xqm';
import module namespace Session = 'http://basex.org/modules/session';

(:~ Session key. :)
declare variable $session:ID := 'dba';
(:~ Current session. :)
declare variable $session:VALUE := Session:get($session:ID);

(:~ Current directory. :)
declare variable $session:DIRECTORY := $session:ID || '-directory';
(:~ Current query. :)
declare variable $session:QUERY := $session:ID || '-query';

(:~
 : Closes the session.
 :)
declare function session:close() as empty-sequence() {
  Session:delete($session:ID)
};

(:~
 : Returns a session value.
 : @return session value
 :)
declare function session:get(
  $name  as xs:string
) as xs:string? {
  Session:get($name)
};

(:~
 : Assigns session values.
 : @param  $name   name
 : @param  $value  value
 :)
declare function session:set(
  $name   as xs:string,
  $value  as xs:string
) as empty-sequence() {
  if($value) then Session:set($name, $value)
  else Session:delete($name)
};

(:~
 : Returns the current query directory.
 : @return directory
 :)
declare function session:directory() as xs:string {
  let $dir := Session:get($session:DIRECTORY)
  return if(exists($dir) and file:exists($dir)) then $dir else $options:DBA-DIRECTORY
};

(:~
 : Returns the names of all files.
 : @return list of files
 :)
declare function session:query-files() as xs:string* {
  let $dir := session:directory()
  where file:exists($dir)
  return file:list($dir)[matches(., '\.xqm?$')]
};
</xqdoc:body></xqdoc:module><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>dba/options</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:namespaces><xqdoc:namespace prefix="session" uri="dba/session"/><xqdoc:namespace prefix="options" uri="dba/options"/><xqdoc:namespace prefix="Session" uri="http://basex.org/modules/session"/></xqdoc:namespaces><xqdoc:variables><xqdoc:variable><xqdoc:name>session:ID</xqdoc:name><xqdoc:comment><xqdoc:description>Session key.</xqdoc:description></xqdoc:comment><xqdoc:type>xs:string</xqdoc:type></xqdoc:variable><xqdoc:variable><xqdoc:name>session:VALUE</xqdoc:name><xqdoc:comment><xqdoc:description>Current session.</xqdoc:description></xqdoc:comment><xqdoc:type occurrence="*">item()</xqdoc:type></xqdoc:variable><xqdoc:variable><xqdoc:name>session:DIRECTORY</xqdoc:name><xqdoc:comment><xqdoc:description>Current directory.</xqdoc:description></xqdoc:comment><xqdoc:type>xs:string</xqdoc:type></xqdoc:variable><xqdoc:variable><xqdoc:name>session:QUERY</xqdoc:name><xqdoc:comment><xqdoc:description>Current query.</xqdoc:description></xqdoc:comment><xqdoc:type>xs:string</xqdoc:type></xqdoc:variable></xqdoc:variables><xqdoc:functions><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Closes the session.</xqdoc:description></xqdoc:comment><xqdoc:name>session:close</xqdoc:name><xqdoc:signature>declare function session:close() as empty-sequence()</xqdoc:signature><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>delete</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>dba/session</xqdoc:uri><xqdoc:name>ID</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function session:close() as empty-sequence() {
  Session:delete($session:ID)
}</xqdoc:body></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description>Returns a session value.</xqdoc:description><xqdoc:return>session value</xqdoc:return></xqdoc:comment><xqdoc:name>session:get</xqdoc:name><xqdoc:signature>declare function session:get($name as xs:string) as xs:string?</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>get</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>name</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function session:get(
  $name  as xs:string
) as xs:string? {
  Session:get($name)
}</xqdoc:body></xqdoc:function><xqdoc:function arity="2"><xqdoc:comment><xqdoc:description>Assigns session values.</xqdoc:description><xqdoc:param>$name   name</xqdoc:param><xqdoc:param>$value  value</xqdoc:param></xqdoc:comment><xqdoc:name>session:set</xqdoc:name><xqdoc:signature>declare function session:set($name as xs:string, $value as xs:string) as empty-sequence()</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>value</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>empty-sequence()</xqdoc:type></xqdoc:return><xqdoc:invoked arity="2"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>set</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>delete</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>value</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>name</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>value</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>name</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function session:set(
  $name   as xs:string,
  $value  as xs:string
) as empty-sequence() {
  if($value) then Session:set($name, $value)
  else Session:delete($name)
}</xqdoc:body></xqdoc:function><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Returns the current query directory.</xqdoc:description><xqdoc:return>directory</xqdoc:return></xqdoc:comment><xqdoc:name>session:directory</xqdoc:name><xqdoc:signature>declare function session:directory() as xs:string</xqdoc:signature><xqdoc:return><xqdoc:type>xs:string</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>http://basex.org/modules/session</xqdoc:uri><xqdoc:name>get</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>exists</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://expath.org/ns/file</xqdoc:uri><xqdoc:name>exists</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>dba/session</xqdoc:uri><xqdoc:name>DIRECTORY</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>dir</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>dir</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>dir</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>dba/options</xqdoc:uri><xqdoc:name>DBA-DIRECTORY</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function session:directory() as xs:string {
  let $dir := Session:get($session:DIRECTORY)
  return if(exists($dir) and file:exists($dir)) then $dir else $options:DBA-DIRECTORY
}</xqdoc:body></xqdoc:function><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Returns the names of all files.</xqdoc:description><xqdoc:return>list of files</xqdoc:return></xqdoc:comment><xqdoc:name>session:query-files</xqdoc:name><xqdoc:signature>declare function session:query-files() as xs:string*</xqdoc:signature><xqdoc:return><xqdoc:type occurrence="*">xs:string</xqdoc:type></xqdoc:return><xqdoc:invoked arity="1"><xqdoc:uri>dba/session</xqdoc:uri><xqdoc:name>directory</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://expath.org/ns/file</xqdoc:uri><xqdoc:name>exists</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="1"><xqdoc:uri>http://expath.org/ns/file</xqdoc:uri><xqdoc:name>list</xqdoc:name></xqdoc:invoked><xqdoc:invoked arity="2"><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>matches</xqdoc:name></xqdoc:invoked><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>dir</xqdoc:name></xqdoc:ref-variable><xqdoc:ref-variable><xqdoc:uri>http://www.w3.org/2005/xpath-functions</xqdoc:uri><xqdoc:name>dir</xqdoc:name></xqdoc:ref-variable><xqdoc:body>function session:query-files() as xs:string* {
  let $dir := session:directory()
  where file:exists($dir)
  return file:list($dir)[matches(., '\.xqm?$')]
}</xqdoc:body></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>