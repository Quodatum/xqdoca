<xqdoc:xqdoc xmlns:xqdoc="http://www.xqdoc.org/1.0"><xqdoc:control><xqdoc:date>2019-06-05T22:42:25.62+01:00</xqdoc:date><xqdoc:version>1.1</xqdoc:version></xqdoc:control><xqdoc:module type="library"><xqdoc:uri>dba/login</xqdoc:uri><xqdoc:name>login.xqm</xqdoc:name><xqdoc:comment><xqdoc:description>Code for logging in and out.</xqdoc:description><xqdoc:author>Christian Grün, BaseX Team 2005-19, BSD License</xqdoc:author><xqdoc:custom tag="__source">login.xqm</xqdoc:custom></xqdoc:comment><xqdoc:body>(:~
 : Code for logging in and out.
 :
 : @author Christian Grün, BaseX Team 2005-19, BSD License
 :)
module namespace dba = 'dba/login';

import module namespace session = 'dba/session' at 'modules/session.xqm';
import module namespace html = 'dba/html' at 'modules/html.xqm';
import module namespace Request = 'http://exquery.org/ns/request';

(:~
 : Permissions: checks the user credentials.
 : @param  $perm  permission data
 : @return redirection to login page or empty sequence
 :)
declare
  %perm:check("/dba", "{$perm}")
function dba:check(
  $perm  as map(*)
) as element(rest:response)? {
  (: redirect to login page if user is not logged in, or if page is not public :)
  let $path := $perm?path
  where not($session:VALUE or $perm?allow = 'all')
  (: normalize login path :)
  let $target := if(ends-with($path, '/dba')) then 'dba/login' else 'login'
  (: last visited page to redirect to (if there was one) :)
  let $page := replace($path, '^.*dba/?', '')[.]
  return web:redirect($target, dba:params(map { '_page': $page }))
};

(:~
 : Login page.
 : @param  $name   user name (optional)
 : @param  $error  error string (optional)
 : @param  $page   page to redirect to (optional)
 : @return page
 :)
declare
  %rest:path("/dba/login")
  %rest:query-param("_name",  "{$name}")
  %rest:query-param("_error", "{$error}")
  %rest:query-param("_page",  "{$page}")
  %output:method("html")
  %perm:allow("all")
function dba:welcome(
  $name   as xs:string?,
  $error  as xs:string?,
  $page   as xs:string?
) as element(html) {
  html:wrap(map { 'error': $error },
    &lt;tr&gt;
      &lt;td&gt;
        &lt;form action="login-check" method="post"&gt;
          &lt;input name="_page" value="{ $page }" type="hidden"/&gt;
          {
            for $param in Request:parameter-names()[not(starts-with(., '_'))]
            return &lt;input name="{ $param }" value="{ Request:parameter($param) }" type="hidden"/&gt;
          }
          &lt;div class='small'/&gt;
          &lt;table&gt;
            &lt;tr&gt;
              &lt;td&gt;&lt;b&gt;Name:&lt;/b&gt;&lt;/td&gt;
              &lt;td&gt;
                &lt;input name="_name" value="{ $name }" id="user" size="30"/&gt;
                { html:focus('user') }
              &lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
              &lt;td&gt;&lt;b&gt;Password:&lt;/b&gt;&lt;/td&gt;
              &lt;td&gt;{
                &lt;input name="_pass" type="password" size="30"/&gt;,
                ' ',
                &lt;input type="submit" value="Login"/&gt;
              }&lt;/td&gt;
            &lt;/tr&gt;
          &lt;/table&gt;
        &lt;/form&gt;
      &lt;/td&gt;
    &lt;/tr&gt;
  )
};

(:~
 : Checks the user input and redirects to the main page, or back to the login page.
 : @param  $name  user name
 : @param  $pass  password
 : @param  $page  page to redirect to (optional)
 : @return redirection
 :)
declare
  %rest:POST
  %rest:path("/dba/login-check")
  %rest:query-param("_name", "{$name}")
  %rest:query-param("_pass", "{$pass}")
  %rest:query-param("_page", "{$page}")
  %perm:allow("all")
function dba:login(
  $name  as xs:string,
  $pass  as xs:string,
  $page  as xs:string?
) as element(rest:response) {
  try {
    user:check($name, $pass),
    if(user:list-details($name)/@permission != 'admin') then (
      dba:reject($name, 'Admin credentials required', $page)
    ) else (
      dba:accept($name, $page)
    )
  } catch user:* {
    dba:reject($name, 'Please check your login data', $page)
  }
};

(:~
 : Ends a session and redirects to the login page.
 : @return redirection
 :)
declare
  %rest:path("/dba/logout")
function dba:logout(
) as element(rest:response) {
  (: write log entry, redirect to login page :)
  admin:write-log('Logout: ' || $session:VALUE, 'DBA'),
  web:redirect("/dba/login", map { '_name': $session:VALUE }),
  (: closes the DBA session :)
  session:close()
};

(:~
 : Registers a user and redirects to the main page.
 : @param  $name  entered user name
 : @param  $page  page to redirect to (optional)
 : @return redirection
 :)
declare %private function dba:accept(
  $name  as xs:string,
  $page  as xs:string?
) as element(rest:response) {
  (: register user, write log entry :)
  session:set($session:ID, $name),
  admin:write-log('Login: ' || $name, 'DBA'),

  (: redirect to supplied page or main page :)
  web:redirect(if($page) then $page else 'logs', dba:params(map { }))
};

(:~
 : Rejects a user and redirects to the login page.
 : @param  $name     entered user name
 : @param  $message  error message
 : @param  $page     page to redirect to (optional)
 : @return redirection
 :)
declare %private function dba:reject(
  $name     as xs:string,
  $message  as xs:string,
  $page     as xs:string?
) as element(rest:response) {
  (: write log entry, redirect to login page :)
  admin:write-log('Login denied: ' || $name, 'DBA'),
  web:redirect(
    "login",
    dba:params(map { '_name': $name, '_error': $message, '_page': $page })
  )
};

(:~
 : Crerates a map with all current query parameters.
 : @param  $map  additional parameters
 : @return map
 :)
declare %private function dba:params(
  $map  as map(*)
) as map(*) {
  map:merge((
    $map,
    for $param in Request:parameter-names()[not(starts-with(., '_'))]
    return map { $param: Request:parameter($param) }
  ))
};
</xqdoc:body></xqdoc:module><xqdoc:namespaces><xqdoc:namespace prefix="dba" uri="dba/login"/><xqdoc:namespace prefix="session" uri="dba/session"/><xqdoc:namespace prefix="html" uri="dba/html"/><xqdoc:namespace prefix="Request" uri="http://exquery.org/ns/request"/><xqdoc:namespace prefix="perm" uri="http://basex.org/modules/perm"/><xqdoc:namespace prefix="rest" uri="http://exquery.org/ns/restxq"/><xqdoc:namespace prefix="output" uri="http://www.w3.org/2010/xslt-xquery-serialization"/><xqdoc:namespace prefix="ann" uri="http://www.w3.org/2012/xquery"/></xqdoc:namespaces><xqdoc:imports><xqdoc:import type="library"><xqdoc:uri>dba/session</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>dba/html</xqdoc:uri></xqdoc:import><xqdoc:import type="library"><xqdoc:uri>http://exquery.org/ns/request</xqdoc:uri></xqdoc:import></xqdoc:imports><xqdoc:variables/><xqdoc:functions><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description>Permissions: checks the user credentials.</xqdoc:description><xqdoc:param>$perm  permission data</xqdoc:param><xqdoc:return>redirection to login page or empty sequence</xqdoc:return></xqdoc:comment><xqdoc:name>dba:check</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="perm:check"><xqdoc:literal type="xs:string">/dba</xqdoc:literal><xqdoc:literal type="xs:string">{$perm}</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %perm:check("/dba", "{$perm}") function dba:check($perm as map(*)) as element(rest:response)?</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>perm</xqdoc:name><xqdoc:type>map(*)</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type occurrence="?">element(rest:response)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="3"><xqdoc:comment><xqdoc:description>Login page.</xqdoc:description><xqdoc:param>$name   user name (optional)</xqdoc:param><xqdoc:param>$error  error string (optional)</xqdoc:param><xqdoc:param>$page   page to redirect to (optional)</xqdoc:param><xqdoc:return>page</xqdoc:return></xqdoc:comment><xqdoc:name>dba:welcome</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="rest:path"><xqdoc:literal type="xs:string">/dba/login</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_name</xqdoc:literal><xqdoc:literal type="xs:string">{$name}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_error</xqdoc:literal><xqdoc:literal type="xs:string">{$error}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_page</xqdoc:literal><xqdoc:literal type="xs:string">{$page}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="output:method"><xqdoc:literal type="xs:string">html</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="perm:allow"><xqdoc:literal type="xs:string">all</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %rest:path("/dba/login") %rest:query-param("_name", "{$name}") %rest:query-param("_error", "{$error}") %rest:query-param("_page", "{$page}") %output:method("html") %perm:allow("all") function dba:welcome($name as xs:string?, $error as xs:string?, $page as xs:string?) as element(html)</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>error</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>page</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>element(html)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="3"><xqdoc:comment><xqdoc:description>Checks the user input and redirects to the main page, or back to the login page.</xqdoc:description><xqdoc:param>$name  user name</xqdoc:param><xqdoc:param>$pass  password</xqdoc:param><xqdoc:param>$page  page to redirect to (optional)</xqdoc:param><xqdoc:return>redirection</xqdoc:return></xqdoc:comment><xqdoc:name>dba:login</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="rest:POST"/><xqdoc:annotation name="rest:path"><xqdoc:literal type="xs:string">/dba/login-check</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_name</xqdoc:literal><xqdoc:literal type="xs:string">{$name}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_pass</xqdoc:literal><xqdoc:literal type="xs:string">{$pass}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="rest:query-param"><xqdoc:literal type="xs:string">_page</xqdoc:literal><xqdoc:literal type="xs:string">{$page}</xqdoc:literal></xqdoc:annotation><xqdoc:annotation name="perm:allow"><xqdoc:literal type="xs:string">all</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %rest:POST %rest:path("/dba/login-check") %rest:query-param("_name", "{$name}") %rest:query-param("_pass", "{$pass}") %rest:query-param("_page", "{$page}") %perm:allow("all") function dba:login($name as xs:string, $pass as xs:string, $page as xs:string?) as element(rest:response)</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>pass</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>page</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>element(rest:response)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="0"><xqdoc:comment><xqdoc:description>Ends a session and redirects to the login page.</xqdoc:description><xqdoc:return>redirection</xqdoc:return></xqdoc:comment><xqdoc:name>dba:logout</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="rest:path"><xqdoc:literal type="xs:string">/dba/logout</xqdoc:literal></xqdoc:annotation></xqdoc:annotations><xqdoc:signature>declare %rest:path("/dba/logout") function dba:logout() as element(rest:response)</xqdoc:signature><xqdoc:return><xqdoc:type>element(rest:response)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="2"><xqdoc:comment><xqdoc:description>Registers a user and redirects to the main page.</xqdoc:description><xqdoc:param>$name  entered user name</xqdoc:param><xqdoc:param>$page  page to redirect to (optional)</xqdoc:param><xqdoc:return>redirection</xqdoc:return></xqdoc:comment><xqdoc:name>dba:accept</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="private"/></xqdoc:annotations><xqdoc:signature>declare %private function dba:accept($name as xs:string, $page as xs:string?) as element(rest:response)</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>page</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>element(rest:response)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="3"><xqdoc:comment><xqdoc:description>Rejects a user and redirects to the login page.</xqdoc:description><xqdoc:param>$name     entered user name</xqdoc:param><xqdoc:param>$message  error message</xqdoc:param><xqdoc:param>$page     page to redirect to (optional)</xqdoc:param><xqdoc:return>redirection</xqdoc:return></xqdoc:comment><xqdoc:name>dba:reject</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="private"/></xqdoc:annotations><xqdoc:signature>declare %private function dba:reject($name as xs:string, $message as xs:string, $page as xs:string?) as element(rest:response)</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>name</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>message</xqdoc:name><xqdoc:type>xs:string</xqdoc:type></xqdoc:parameter><xqdoc:parameter><xqdoc:name>page</xqdoc:name><xqdoc:type occurrence="?">xs:string</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>element(rest:response)</xqdoc:type></xqdoc:return></xqdoc:function><xqdoc:function arity="1"><xqdoc:comment><xqdoc:description>Crerates a map with all current query parameters.</xqdoc:description><xqdoc:param>$map  additional parameters</xqdoc:param><xqdoc:return>map</xqdoc:return></xqdoc:comment><xqdoc:name>dba:params</xqdoc:name><xqdoc:annotations><xqdoc:annotation name="private"/></xqdoc:annotations><xqdoc:signature>declare %private function dba:params($map as map(*)) as map(*)</xqdoc:signature><xqdoc:parameters><xqdoc:parameter><xqdoc:name>map</xqdoc:name><xqdoc:type>map(*)</xqdoc:type></xqdoc:parameter></xqdoc:parameters><xqdoc:return><xqdoc:type>map(*)</xqdoc:type></xqdoc:return></xqdoc:function></xqdoc:functions></xqdoc:xqdoc>